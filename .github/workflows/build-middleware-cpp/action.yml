# Copyright (c) 2021 Concurrent Technologies Corporation.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software is distributed under the License is
# distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied.  See the License for the specific language governing permissions and limitations under the License.

---
name: Build C++ Middleware
description: Reusable action to build omega-edit C++ gRPC middleware server
inputs:
  runner-os:
    description: 'OS Name of Runner (macOS, Linux, Windows)'
    required: true
  os-name:
    description: 'OS Name (runs-on value)'
    required: true
  github-token:
    description: 'GitHub token retrieved from secrets'
    required: true
runs:
  using: "composite"
  steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v6

    - name: Setup Node.js ğŸŸ¢
      uses: actions/setup-node@v6
      with:
        node-version: 20
        cache: yarn
        cache-dependency-path: yarn.lock

    - name: Enable Developer Command Prompt ğŸ’»
      if: inputs.runner-os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup cmake ğŸ”§
      uses: lukka/get-cmake@latest

    - name: Build omega_edit core library (static) ğŸ¦™
      shell: bash
      run: |
        cmake -G Ninja -S . -B _build_core \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_DOCS=OFF \
          -DBUILD_EXAMPLES=OFF \
          -DBUILD_TESTS=OFF
        cmake --build _build_core --config Release
        cmake --install _build_core/packages/core --prefix "$(pwd)/_install_core" --config Release
        echo "OE_LIB_DIR=$(pwd)/_install_core/lib" >> $GITHUB_ENV
        echo "OE_PREFIX=$(pwd)/_install_core" >> $GITHUB_ENV

    - name: Set vcpkg triplet ğŸ”§
      shell: bash
      run: |
        arch=$(uname -m)
        if [ "${{ inputs.runner-os }}" == "Windows" ]; then
          echo "VCPKG_TRIPLET=x64-windows" >> $GITHUB_ENV
        elif [ "${{ inputs.runner-os }}" == "macOS" ]; then
          if [ "$arch" == "arm64" ]; then
            echo "VCPKG_TRIPLET=arm64-osx" >> $GITHUB_ENV
          else
            echo "VCPKG_TRIPLET=x64-osx" >> $GITHUB_ENV
          fi
        else
          if [ "$arch" == "aarch64" ]; then
            echo "VCPKG_TRIPLET=arm64-linux" >> $GITHUB_ENV
          else
            echo "VCPKG_TRIPLET=x64-linux" >> $GITHUB_ENV
          fi
        fi

    - name: Cache vcpkg packages ğŸ“¦
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/vcpkg_installed
        key: vcpkg-grpc-${{ inputs.os-name }}-${{ hashFiles('proto/omega_edit.proto') }}
        restore-keys: |
          vcpkg-grpc-${{ inputs.os-name }}-

    - name: Install gRPC dependencies via vcpkg ğŸ”§
      shell: bash
      run: |
        vcpkg install "grpc:$VCPKG_TRIPLET" "protobuf:$VCPKG_TRIPLET" \
          --x-install-root="${{ github.workspace }}/vcpkg_installed"
        echo "CMAKE_TOOLCHAIN_FILE=$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $GITHUB_ENV
        echo "VCPKG_INSTALLED_DIR=${{ github.workspace }}/vcpkg_installed" >> $GITHUB_ENV

    - name: Install uuid-dev (Linux) ğŸ”§
      if: inputs.runner-os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y uuid-dev

    - name: Build C++ gRPC Server ğŸ”¨
      shell: bash
      run: |
        cmake -G Ninja -S server/cpp -B server/cpp/build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE="$CMAKE_TOOLCHAIN_FILE" \
          -DVCPKG_TARGET_TRIPLET="$VCPKG_TRIPLET" \
          -DVCPKG_INSTALLED_DIR="$VCPKG_INSTALLED_DIR" \
          -DOE_LIB_DIR="$OE_LIB_DIR" \
          -DCMAKE_PREFIX_PATH="$OE_PREFIX"
        cmake --build server/cpp/build --config Release
        echo "CPP_SERVER_BINARY=$(pwd)/server/cpp/build/omega-edit-grpc-server$([ '${{ inputs.runner-os }}' == 'Windows' ] && echo '.exe' || echo '')" >> $GITHUB_ENV

    - name: Yarn Install ğŸ—ï¸
      shell: bash
      run: yarn

    - name: Yarn Package - Server ğŸ“¦
      shell: bash
      run: yarn workspace @omega-edit/server package
      env:
        CPP_SERVER_BINARY: ${{ env.CPP_SERVER_BINARY }}

    - name: Yarn Prepare - Client
      shell: bash
      run: yarn workspace @omega-edit/client prepare

    - name: Yarn Test - Client ğŸ§‘â€ğŸ’¼
      shell: ${{ (inputs.runner-os == 'Windows') && 'pwsh' || 'bash' }}
      run: yarn workspace @omega-edit/client test

    - name: Yarn Test - Client (UDS) ğŸ§ª
      shell: ${{ (inputs.runner-os == 'Windows') && 'pwsh' || 'bash' }}
      run: yarn workspace @omega-edit/client test:uds
      if: ${{ inputs.runner-os != 'Windows' }}
